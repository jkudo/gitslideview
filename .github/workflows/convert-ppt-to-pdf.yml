name: Convert PowerPoint to PDF

on:
  push:
    # powepoint ディレクトリ内のファイルが変更された場合に実行
    paths:
      - 'powepoint/**'
  workflow_dispatch:  # 手動実行も可能

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      - name: リポジトリのチェックアウト
        uses: actions/checkout@v3

      - name: LibreOffice のインストール
        run: |
          sudo apt-get update
          sudo apt-get install -y libreoffice

      - name: PowerPoint を PDF に変換
        run: |
          # 変換後の PDF を出力するディレクトリを作成
          mkdir -p pdf

          # powepoint ディレクトリ内のファイルを確認
          echo "== powepoint ディレクトリの内容 =="
          ls -la powepoint

          # .pptx ファイルの変換
          for file in powepoint/*.pptx; do
            if [ -e "$file" ]; then
              echo "Converting $file"
              libreoffice --headless --convert-to pdf "$file" --outdir pdf
            else
              echo "No .pptx files found"
            fi
          done

          # .ppt ファイルの変換（存在する場合）
          for file in powepoint/*.ppt; do
            if [ -e "$file" ]; then
              echo "Converting $file"
              libreoffice --headless --convert-to pdf "$file" --outdir pdf
            else
              echo "No .ppt files found"
            fi
          done

          # 変換結果の確認
          echo "== pdf ディレクトリの内容 =="
          ls -la pdf

      - name: 生成された PDF をコミットしてプッシュ
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          # pdf ディレクトリ内に PDF ファイルが存在する場合のみ git add を実行
          if compgen -G "pdf/*.pdf" > /dev/null; then
              git add pdf/*.pdf
          else
              echo "pdf ディレクトリに PDF ファイルが存在しません"
          fi

          # 変更があればコミット（コミットメッセージに [skip ci] を含め、再実行を防止）
          if [ -n "$(git status --porcelain)" ]; then
              git commit -m "Update converted PDFs [skip ci]"
              git push
          else
              echo "コミットする変更はありません"
          fi
